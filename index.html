<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>English Coach ‚Äî Mega + Live Score (v1.7 Google-accurate RU Translate)</title>
<style>
  :root{
    --bg:#0b0f14;--card:rgba(255,255,255,.08);--stroke:rgba(255,255,255,.18);
    --accent:#6ae3ff;--accent2:#8d7bff;--good:#35d07f;--warn:#ffcf5c;--bad:#ff5c7a;
    --txt:#e7edf5;--muted:#9fb2c6;--shadow:0 20px 60px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.06);
    --radius:16px
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
    color:var(--txt);
    background:
      radial-gradient(1200px 800px at 20% -10%,#17324a 0%,transparent 60%),
      radial-gradient(1000px 700px at 120% 10%,#2a1b4d 0%,transparent 60%),#0b0f14;
    min-height:100svh
  }
  header{position:sticky;top:0;backdrop-filter:saturate(120%) blur(14px);
    background:linear-gradient(180deg,rgba(12,16,23,.9),rgba(12,16,23,.6));
    border-bottom:1px solid var(--stroke);z-index:10}
  .wrap{max-width:1100px;margin:0 auto;padding:20px}
  .topbar{display:flex;align-items:center;gap:14px;justify-content:space-between;flex-wrap:wrap}
  .brand{display:flex;align-items:center;gap:12px;font-weight:800;letter-spacing:.2px}
  .logo{width:34px;height:34px;border-radius:10px;background:conic-gradient(from 210deg,var(--accent),var(--accent2));
    box-shadow:0 6px 18px rgba(106,227,255,.25),inset 0 0 12px rgba(255,255,255,.2)}
  nav{display:flex;gap:8px;flex-wrap:nowrap;overflow:auto;white-space:nowrap;scrollbar-width:thin;padding-bottom:2px}
  nav::-webkit-scrollbar{height:6px}
  nav button{
    border:1px solid var(--stroke);background:var(--card);color:var(--txt);
    padding:10px 14px;border-radius:12px;cursor:pointer;
    transition:.2s transform,.2s background;flex:0 0 auto
  }
  nav button.active,nav button:hover{
    background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.02));
    transform:translateY(-1px)
  }

  .controls{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .select,.btn,.input,select,input,textarea{
    background:var(--card);border:1px solid var(--stroke);color:var(--txt);
    border-radius:12px;padding:10px 12px;outline:none
  }
  .btn{cursor:pointer;font-weight:600;letter-spacing:.2px;box-shadow:var(--shadow);
    background:linear-gradient(180deg,rgba(255,255,255,.12),rgba(255,255,255,.04))}
  .btn.primary{background:linear-gradient(180deg,rgba(106,227,255,.35),rgba(141,123,255,.25));border-color:transparent}

  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:18px}
  .card{background:var(--card);border:1px solid var(--stroke);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
  h1,h2{margin:.2em 0 .6em 0}
  h1{font-size:26px}
  h2{font-size:20px;color:var(--muted)}
  .muted{color:var(--muted)}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .stack{display:flex;flex-direction:column;gap:12px}
  .big{font-size:44px;font-weight:800;letter-spacing:.6px}
  .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);background:var(--card);color:var(--muted)}
  .progress{height:14px;background:#0e141c;border:1px solid var(--stroke);border-radius:999px;overflow:hidden}
  .progress>span{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--bad),var(--warn),var(--good))}
  .scoreline{display:flex;align-items:center;gap:10px;font-family:ui-monospace,Menlo,Consolas,monospace}
  .scoreline .score{font-weight:800}
  .score.good{color:var(--good)}.score.mid{color:var(--warn)}.score.bad{color:var(--bad)}
  .vu{height:40px;border-radius:10px;background:#0d1218;border:1px solid var(--stroke);display:grid;grid-template-columns:repeat(32,1fr);gap:2px;padding:4px}
  .vu div{background:#101826;border-radius:4px;transition:height .06s ease,background .12s ease}
  .target,.live{font-family:ui-monospace,Menlo,Consolas,monospace}
  .tag{font-size:12px;color:var(--muted)}
  .list{display:flex;flex-direction:column;gap:10px;max-height:360px;overflow:auto;padding-right:4px}
  .list button{justify-content:space-between;width:100%;display:flex}
  .phrase{padding:8px 10px;border-radius:10px;border:1px solid var(--stroke);background:var(--card)}
  .kbd{font-family:ui-monospace,monospace;font-weight:700;background:#0c1118;border:1px solid var(--stroke);padding:2px 6px;border-radius:6px}
  .footer-note{color:var(--muted);font-size:12px}
  .lang-toggle{display:flex;gap:6px;align-items:center}
  .hidden{display:none!important}
  .shine{position:relative;overflow:hidden}
  .shine::after{content:"";position:absolute;inset:-200% -150%;
    background:conic-gradient(from 180deg,transparent 0 46%,rgba(255,255,255,.3) 48% 52%,transparent 54% 100%);
    animation:shine 6s linear infinite}
  @keyframes shine{to{transform:translateX(40%)}}

  .trans-box{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .trans-title{color:var(--muted);font-size:12px}
  .trans-actions a, .trans-actions button{color:var(--accent);text-decoration:none;border:1px solid var(--stroke);padding:4px 8px;border-radius:8px;background:transparent;cursor:pointer}
  .trans{margin-top:6px;min-height:24px}

  @media (max-width: 1024px){ .grid{grid-template-columns:1fr} .list{max-height:46vh} }
  @media (max-width: 640px){
    .wrap{padding:14px}
    .brand .big{font-size:28px}
    h1{font-size:22px} h2{font-size:18px}
    nav button{padding:8px 12px}
    .card{padding:14px;border-radius:14px}
    .row--stack-m{flex-direction:column;align-items:stretch}
    .btn, .select, .input, select, input, textarea{padding:12px 12px;border-radius:14px}
    .btn, .select{min-height:44px}
    .vu{height:28px}
    .list{max-height:50vh}
    .controls .lang-toggle{display:none}
    .target{font-size:20px}
  }
</style>
</head>
<body>
<header>
  <div class="wrap topbar">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <div class="big">English Coach</div>
        <div class="muted" data-i18n="subtitle">–ü—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ, —Å–ª–æ–≤–∞ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å</div>
      </div>
    </div>
    <nav id="tabs" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Ä–∞–∑–¥–µ–ª–∞–º">
      <button data-tab="home" class="active" data-i18n="tab_home">–ì–ª–∞–≤–Ω–∞—è</button>
      <button data-tab="pronounce" data-i18n="tab_pron">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏—è</button>
      <button data-tab="custom" data-i18n="tab_custom">–°–≤–æ—è —Ñ—Ä–∞–∑–∞</button>
      <button data-tab="vocab" data-i18n="tab_vocab">–ò–∑—É—á–µ–Ω–∏–µ —Å–ª–æ–≤</button>
      <button data-tab="settings" data-i18n="tab_settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    </nav>
    <div class="controls">
      <div class="lang-toggle" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —è–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞">
        <span class="pill">RU / EN</span>
        <label class="pill" style="display:flex;align-items:center;gap:6px;padding:6px 8px">
          <input type="checkbox" id="langSwitch"/><span id="langLabel">RU</span>
        </label>
      </div>
    </div>
  </div>
</header>

<main class="wrap stack" style="padding-top:18px;padding-bottom:40px">
  <section id="home" class="grid">
    <div class="card shine">
      <h1 data-i18n="home_title">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h1>
      <p class="muted" data-i18n="home_p1">
        –í–µ—Ä—Å–∏—è Mega + Live Score: —Ä–µ–∞–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –ø—Ä–∏ —Ä–µ—á–∏, –º–µ–≥–∞–ø–∞–∫–∏ &gt;1000 —Ñ—Ä–∞–∑, —Ñ–∏–∫—Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –≤–æ ¬´–°–≤–æ—è —Ñ—Ä–∞–∑–∞¬ª.
      </p>
      <div class="row row--stack-m" style="gap:16px;margin-top:10px">
        <button class="btn primary" onclick="goTab('pronounce')" data-i18n="home_cta1">–ù–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</button>
        <button class="btn" onclick="goTab('custom')" data-i18n="home_cta2">–°–≤–æ—è —Ñ—Ä–∞–∑–∞</button>
      </div>
      <ul class="muted" style="margin-top:16px;line-height:1.7">
        <li data-i18n="home_l1">–û—Ü–µ–Ω–∫–∞ –ø–æ –õ–µ–≤–µ–Ω—à—Ç–µ–π–Ω—É –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</li>
        <li data-i18n="home_l2">VU-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –≥—Ä–æ–º–∫–æ—Å—Ç–∏ –∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏</li>
        <li data-i18n="home_l3">–ú–µ–≥–∞–ø–∞–∫–∏ —Ñ—Ä–∞–∑, TTS-–æ–∑–≤—É—á–∫–∞</li>
        <li data-i18n="home_l4">–õ—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ</li>
        <li data-i18n="home_l5">–†—É—Å—Å–∫–∏–π / –∞–Ω–≥–ª–∏–π—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å</li>
      </ul>
      <div class="footer-note" data-i18n="home_note">
        –°–æ–≤–µ—Ç: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–∞—É—à–Ω–∏–∫–∏, —á—Ç–æ–±—ã –º–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –ª–æ–≤–∏–ª –∑–≤—É–∫ —Å–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä–∞ —Ä–µ—á–∏.
      </div>
    </div>

    <div class="card">
      <h2 data-i18n="quick_start">–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç</h2>
      <ol class="muted" style="line-height:1.8">
        <li data-i18n="qs1">–û—Ç–∫—Ä–æ–π—Ç–µ –≤–∫–ª–∞–¥–∫—É ¬´–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏—è¬ª –∏–ª–∏ ¬´–°–≤–æ—è —Ñ—Ä–∞–∑–∞¬ª.</li>
        <li data-i18n="qs2">–ù–∞–∂–º–∏—Ç–µ ¬´–ì–æ–≤–æ—Ä–∏—Ç—å¬ª –∏ —á–∏—Ç–∞–π—Ç–µ —Ü–µ–ª—å –≤—Å–ª—É—Ö; –ø—Ä–æ—Ü–µ–Ω—Ç –±—É–¥–µ—Ç –º–µ–Ω—è—Ç—å—Å—è –æ–Ω–ª–∞–π–Ω.</li>
        <li data-i18n="qs3">–†–µ–∫–æ—Ä–¥ –ø–æ —Ñ—Ä–∞–∑–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (üèÜ).</li>
      </ol>
      <div class="pill" id="supportNote"></div>
    </div>
  </section>

  <section id="pronounce" class="grid hidden">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <h1 data-i18n="pron_title">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏—è</h1>
        <div class="row"><span class="pill" id="bestRecord" title="Best score">üèÜ 0%</span></div>
      </div>

      <div class="row row--stack-m" style="gap:12px">
        <label class="pill"><span data-i18n="level">–£—Ä–æ–≤–µ–Ω—å:</span>
          <select id="levelSel" class="select">
            <option value="beginner" selected>Beginner</option>
            <option value="intermediate">Intermediate</option>
            <option value="advanced">Advanced</option>
          </select>
        </label>
        <label class="pill"><span data-i18n="pack">–ù–∞–±–æ—Ä —Ñ—Ä–∞–∑:</span>
          <select id="packSel" class="select"></select>
        </label>
        <label class="pill"><span data-i18n="rec_lang">–Ø–∑—ã–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:</span>
          <select id="recLang" class="select">
            <option value="en-US">English (US)</option>
            <option value="en-GB">English (UK)</option>
          </select>
        </label>
      </div>

      <div class="stack" style="margin-top:10px">
        <div class="target" id="targetPhrase" style="font-size:22px"></div>
        <div class="trans-box">
          <span class="trans-title">–ü–µ—Ä–µ–≤–æ–¥ —Ü–µ–ª–∏:</span>
          <div class="trans-actions">
            <button id="toggleTranslator" title="–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ EN‚ÜíRU">üåê –ü–µ—Ä–µ–≤–æ–¥—á–∏–∫: <span id="trMode">Google</span></button>
            <a id="gtTarget" target="_blank" rel="noopener">Google</a>
          </div>
        </div>
        <div class="phrase trans" id="targetTrans"></div>

        <div class="live muted" id="liveText" style="min-height:24px"></div>
        <div class="trans-box">
          <span class="trans-title">–ü–µ—Ä–µ–≤–æ–¥ —Ä–µ—á–∏ (–æ–Ω–ª–∞–π–Ω):</span>
          <div class="trans-actions"><a id="gtLive" target="_blank" rel="noopener">Google</a></div>
        </div>
        <div class="phrase trans muted" id="liveTrans"></div>

        <div class="progress"><span id="simBar"></span></div>
        <div class="scoreline"><span class="muted">–û—Ü–µ–Ω–∫–∞:</span><span id="simText" class="score">0%</span></div>

        <div class="row row--stack-m" style="gap:10px">
          <button class="btn" id="prevBtn">‚üµ</button>
          <button class="btn primary" id="speakBtn" data-i18n="listen">–°–ª—É—à–∞—Ç—å</button>
          <button class="btn" id="recBtn" data-i18n="talk">–ì–æ–≤–æ—Ä–∏—Ç—å</button>
          <button class="btn" id="finishBtn" data-i18n="finish">–°—Ç–æ–ø</button>
          <button class="btn" id="nextBtn">‚ü∂</button>
        </div>

        <div class="tag" data-i18n="hint_keys">–ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏: L ‚Äî —Å–ª—É—à–∞—Ç—å, G ‚Äî –≥–æ–≤–æ—Ä–∏—Ç—å, ‚Üê/‚Üí ‚Äî —Ñ—Ä–∞–∑–∞</div>
        <div class="vu" id="vu"></div>
      </div>
    </div>

    <div class="card">
      <h2 data-i18n="phrases">–§—Ä–∞–∑—ã</h2>
      <div class="list" id="phraseList"></div>
    </div>
  </section>

  <section id="custom" class="grid hidden">
    <div class="card">
      <h1 data-i18n="custom_title">–°–≤–æ—è —Ñ—Ä–∞–∑–∞</h1>
      <textarea id="customText" rows="3" class="input" placeholder="Type or paste your phrase here..."></textarea>

      <div class="trans-box" style="margin-top:8px">
        <span class="trans-title">–ü–µ—Ä–µ–≤–æ–¥ —Ü–µ–ª–∏:</span>
        <div class="trans-actions">
          <a id="gtCustomTarget" target="_blank" rel="noopener">Google</a>
        </div>
      </div>
      <div class="phrase trans" id="customTargetTrans"></div>

      <div class="row row--stack-m" style="margin-top:10px">
        <button class="btn primary" id="ttsCustom" data-i18n="listen">–°–ª—É—à–∞—Ç—å</button>
        <button class="btn" id="recCustom" data-i18n="talk">–ì–æ–≤–æ—Ä–∏—Ç—å</button>
        <button class="btn" id="finishCustom" data-i18n="finish">–°—Ç–æ–ø</button>
      </div>

      <div class="live muted" id="liveCustom" style="min-height:24px;margin-top:8px"></div>
      <div class="trans-box">
        <span class="trans-title">–ü–µ—Ä–µ–≤–æ–¥ —Ä–µ—á–∏ (–æ–Ω–ª–∞–π–Ω):</span>
        <div class="trans-actions"><a id="gtCustomLive" target="_blank" rel="noopener">Google</a></div>
      </div>
      <div class="phrase trans muted" id="liveCustomTrans"></div>

      <div class="progress" style="margin-top:10px"><span id="simBarCustom"></span></div>
      <div class="scoreline"><span class="muted">–û—Ü–µ–Ω–∫–∞:</span><span id="simTextCustom" class="score">0%</span></div>
      <div class="vu" id="vu2" style="margin-top:10px"></div>
    </div>

    <div class="card">
      <h2 data-i18n="tips">–°–æ–≤–µ—Ç—ã</h2>
      <ul class="muted" style="line-height:1.8">
        <li data-i18n="tip1">–ö–æ—Ä–æ—Ç–∫–∏–µ —Ñ—Ä–∞–∑—ã —Ä–∞—Å–ø–æ–∑–Ω–∞—é—Ç—Å—è —Ç–æ—á–Ω–µ–µ. –ù–∞—á–Ω–∏—Ç–µ —Å –Ω–∏—Ö.</li>
        <li data-i18n="tip2">–°—Ç–∞–≤—å—Ç–µ –∑–∞–ø—è—Ç—ã–µ –¥–ª—è –ø–∞—É–∑, –ø—Ä–æ–±—É–π—Ç–µ —Ä–∞–∑–Ω—ã–µ –≥–æ–ª–æ—Å–∞ TTS.</li>
      </ul>
    </div>
  </section>

  <section id="vocab" class="grid hidden">
    <div class="card">
      <h1 data-i18n="vocab_title">–ò–∑—É—á–µ–Ω–∏–µ —Å–ª–æ–≤</h1>
      <div class="row row--stack-m" style="gap:10px">
        <button class="btn" id="vocabPrev">‚üµ</button>
        <div class="phrase" id="vocabWord" style="font-size:22px;min-width:200px">‚Äî</div>
        <button class="btn" id="vocabNext">‚ü∂</button>
        <button class="btn primary" id="vocabSpeak" data-i18n="listen">–°–ª—É—à–∞—Ç—å</button>
        <button class="btn" id="vocabReveal" data-i18n="reveal">–ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥</button>
      </div>
      <div class="phrase" id="vocabTrans" style="margin-top:10px;display:none"></div>
      <div class="row" style="margin-top:10px;gap:10px">
        <button class="btn" id="markEasy" data-i18n="easy">–õ–µ–≥–∫–æ</button>
        <button class="btn" id="markHard" data-i18n="hard">–°–ª–æ–∂–Ω–æ</button>
        <span class="pill" id="vocabProgress">0/0</span>
      </div>
    </div>

    <div class="card">
      <h2 data-i18n="vocab_sets">–ù–∞–±–æ—Ä—ã —Å–ª–æ–≤</h2>
      <div class="list" id="vocabList"></div>
    </div>

    <div class="card">
      <h2>–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ/–∏–º–ø–æ—Ä—Ç –Ω–∞–±–æ—Ä–æ–≤</h2>
      <div class="stack">
        <div class="row row--stack-m">
          <label class="pill"><span>–†–∞–∑–º–µ—Ä –º–µ–≥–∞–ø–∞–∫–∞:</span><input type="number" id="megaSize" min="200" max="3000" step="50" value="1200" style="width:120px"/></label>
          <label class="pill"><span>Seed:</span><input type="number" id="megaSeed" min="1" max="999999" value="42" style="width:120px"/></label>
          <button class="btn" id="regenMega">üîÅ –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –º–µ–≥–∞–ø–∞–∫</button>
        </div>
        <div class="row row--stack-m">
          <input class="input" id="packsUrl" placeholder="URL –¥–æ JSON —Å –Ω–∞–±–æ—Ä–∞–º–∏ (—Å—Ö–µ–º–∞: { 'Set': [['word','–ø–µ—Ä–µ–≤–æ–¥'],...] })" style="flex:1;min-width:260px"/>
          <button class="btn" id="loadPacksUrl">–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ URL</button>
        </div>
        <div class="row row--stack-m">
          <input type="file" id="packsFile" accept=".json" class="input"/>
          <button class="btn" id="loadPacksFile">–ò–º–ø–æ—Ä—Ç –∏–∑ —Ñ–∞–π–ª–∞</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>–°–≤–æ–∏ —Å–ª–æ–≤–∞</h2>
      <p class="muted">–°—Ç—Ä–æ–∫–∏ –≤–∏–¥–∞ <span class="kbd">word ‚Äî –ø–µ—Ä–µ–≤–æ–¥</span> (–æ–¥–Ω–æ —Å–ª–æ–≤–æ –Ω–∞ —Å—Ç—Ä–æ–∫—É). –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å: –¥–µ—Ñ–∏—Å/—Ç–∏—Ä–µ –∏–ª–∏ —Ç–æ—á–∫–∞ —Å –∑–∞–ø—è—Ç–æ–π.</p>
      <div class="row row--stack-m" style="gap:10px">
        <input class="input" id="vocabSetName" placeholder="–ù–∞–ø—Ä.: My Travel Pack" style="min-width:220px"/>
        <button class="btn" id="addVocabSet">–î–æ–±–∞–≤–∏—Ç—å –Ω–∞–±–æ—Ä</button>
      </div>
      <textarea id="vocabImport" class="input" rows="6" placeholder="apple ‚Äî —è–±–ª–æ–∫–æ
ticket ‚Äî –±–∏–ª–µ—Ç
delicious ‚Äî –≤–∫—É—Å–Ω—ã–π
..."></textarea>
    </div>
  </section>

  <section id="settings" class="grid hidden">
    <div class="card">
      <h1 data-i18n="settings_title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>
      <div class="stack">
        <div class="row row--stack-m">
          <label class="pill"><span data-i18n="tts_voice">–ì–æ–ª–æ—Å TTS:</span><select id="voiceSel" class="select"></select></label>
          <label class="pill"><span data-i18n="rate">–°–∫–æ—Ä–æ—Å—Ç—å:</span><input type="range" min="0.6" max="1.4" step="0.05" id="rate" value="1"/></label>
          <label class="pill"><span data-i18n="pitch">–í—ã—Å–æ—Ç–∞:</span><input type="range" min="0.6" max="1.6" step="0.05" id="pitch" value="1"/></label>
          <label class="pill"><span data-i18n="volume">–ì—Ä–æ–º–∫–æ—Å—Ç—å:</span><input type="range" min="0" max="1" step="0.05" id="volume" value="1"/></label>
        </div>
        <div class="footer-note">–°—Ç–∞—Ç—É—Å –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫–∞: <span id="translatorStatus">‚Äî</span></div>
        <div class="footer-note" id="permNote"></div>
      </div>
    </div>
    <div class="card">
      <h2 data-i18n="about">–û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</h2>
      <p class="muted" data-i18n="about_p">–†–∞–±–æ—Ç–∞–µ—Ç –æ—Ñ–ª–∞–π–Ω (–∫—Ä–æ–º–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –∏ –æ–Ω–ª–∞–π–Ω‚Äë–ø–µ—Ä–µ–≤–æ–¥–∞), —Ö—Ä–∞–Ω–∏—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å –ª–æ–∫–∞–ª—å–Ω–æ, –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–æ–∫.</p>
      <div class="pill">v1.7 Google-accurate RU Translate</div>
    </div>
  </section>
</main>

<script>
/* ===== I18N ===== */
const I18N={ru:{subtitle:"–ü—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ, —Å–ª–æ–≤–∞ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å",tab_home:"–ì–ª–∞–≤–Ω–∞—è",tab_pron:"–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏—è",tab_custom:"–°–≤–æ—è —Ñ—Ä–∞–∑–∞",tab_vocab:"–ò–∑—É—á–µ–Ω–∏–µ —Å–ª–æ–≤",tab_settings:"–ù–∞—Å—Ç—Ä–æ–π–∫–∏",home_title:"–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!",home_p1:"–í–µ—Ä—Å–∏—è Mega + Live Score: —Ä–µ–∞–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –ø—Ä–∏ —Ä–µ—á–∏, –º–µ–≥–∞–ø–∞–∫–∏ >1000 —Ñ—Ä–∞–∑, —Ñ–∏–∫—Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –≤–æ ¬´–°–≤–æ—è —Ñ—Ä–∞–∑–∞¬ª.",home_cta1:"–ù–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É",home_cta2:"–°–≤–æ—è —Ñ—Ä–∞–∑–∞",home_l1:"–û—Ü–µ–Ω–∫–∞ –ø–æ –õ–µ–≤–µ–Ω—à—Ç–µ–π–Ω—É –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏",home_l2:"VU-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –≥—Ä–æ–º–∫–æ—Å—Ç–∏ –∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏",home_l3:"–ú–µ–≥–∞–ø–∞–∫–∏ —Ñ—Ä–∞–∑, TTS-–æ–∑–≤—É—á–∫–∞",home_l4:"–õ—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ",home_l5:"–†—É—Å—Å–∫–∏–π / –∞–Ω–≥–ª–∏–π—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å",home_note:"–°–æ–≤–µ—Ç: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–∞—É—à–Ω–∏–∫–∏, —á—Ç–æ–±—ã –º–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –ª–æ–≤–∏–ª –∑–≤—É–∫ —Å–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä–∞ —Ä–µ—á–∏.",quick_start:"–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç",qs1:"–û—Ç–∫—Ä–æ–π—Ç–µ –≤–∫–ª–∞–¥–∫—É ¬´–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏—è¬ª –∏–ª–∏ ¬´–°–≤–æ—è —Ñ—Ä–∞–∑–∞¬ª.",qs2:"–ù–∞–∂–º–∏—Ç–µ ¬´–ì–æ–≤–æ—Ä–∏—Ç—å¬ª –∏ —á–∏—Ç–∞–π—Ç–µ —Ü–µ–ª—å –≤—Å–ª—É—Ö; –ø—Ä–æ—Ü–µ–Ω—Ç –±—É–¥–µ—Ç –º–µ–Ω—è—Ç—å—Å—è –æ–Ω–ª–∞–π–Ω.",qs3:"–†–µ–∫–æ—Ä–¥ –ø–æ —Ñ—Ä–∞–∑–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (üèÜ).",pron_title:"–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏—è",level:"–£—Ä–æ–≤–µ–Ω—å:",pack:"–ù–∞–±–æ—Ä —Ñ—Ä–∞–∑:",rec_lang:"–Ø–∑—ã–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:",listen:"–°–ª—É—à–∞—Ç—å",talk:"–ì–æ–≤–æ—Ä–∏—Ç—å",finish:"–°—Ç–æ–ø",hint_keys:"–ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏: L ‚Äî —Å–ª—É—à–∞—Ç—å, G ‚Äî –≥–æ–≤–æ—Ä–∏—Ç—å, ‚Üê/‚Üí ‚Äî —Ñ—Ä–∞–∑–∞",phrases:"–§—Ä–∞–∑—ã",custom_title:"–°–≤–æ—è —Ñ—Ä–∞–∑–∞",tips:"–°–æ–≤–µ—Ç—ã",tip1:"–ö–æ—Ä–æ—Ç–∫–∏–µ —Ñ—Ä–∞–∑—ã —Ä–∞—Å–ø–æ–∑–Ω–∞—é—Ç—Å—è —Ç–æ—á–Ω–µ–µ. –ù–∞—á–Ω–∏—Ç–µ —Å –Ω–∏—Ö.",tip2:"–°—Ç–∞–≤—å—Ç–µ –∑–∞–ø—è—Ç—ã–µ –¥–ª—è –ø–∞—É–∑, –ø—Ä–æ–±—É–π—Ç–µ —Ä–∞–∑–Ω—ã–µ –≥–æ–ª–æ—Å–∞ TTS.",vocab_title:"–ò–∑—É—á–µ–Ω–∏–µ —Å–ª–æ–≤",reveal:"–ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥",easy:"–õ–µ–≥–∫–æ",hard:"–°–ª–æ–∂–Ω–æ",vocab_sets:"–ù–∞–±–æ—Ä—ã —Å–ª–æ–≤",settings_title:"–ù–∞—Å—Ç—Ä–æ–π–∫–∏",tts_voice:"–ì–æ–ª–æ—Å TTS:",rate:"–°–∫–æ—Ä–æ—Å—Ç—å:",pitch:"–í—ã—Å–æ—Ç–∞:",volume:"–ì—Ä–æ–º–∫–æ—Å—Ç—å:",test:"–¢–µ—Å—Ç",clear:"–°–±—Ä–æ—Å–∏—Ç—å –ª—É—á—à–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã",about:"–û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏",about_p:"–†–∞–±–æ—Ç–∞–µ—Ç –æ—Ñ–ª–∞–π–Ω (–∫—Ä–æ–º–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –∏ –æ–Ω–ª–∞–π–Ω‚Äë–ø–µ—Ä–µ–≤–æ–¥–∞), —Ö—Ä–∞–Ω–∏—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å –ª–æ–∫–∞–ª—å–Ω–æ, –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–æ–∫."},
en:{subtitle:"Pronunciation, vocabulary & progress",tab_home:"Home",tab_pron:"Pronunciation Training",tab_custom:"Custom Phrase",tab_vocab:"Word Study",tab_settings:"Settings",home_title:"Welcome!",home_p1:"Mega + Live Score: real-time scoring, 1000+ phrase mega-packs, custom mic fix.",home_cta1:"Start Training",home_cta2:"Custom Phrase",home_l1:"Real-time Levenshtein scoring",home_l2:"VU meter & speech recognition",home_l3:"Mega phrase packs, TTS playback",home_l4:"Best results saved locally",home_l5:"Bilingual interface (RU/EN)",home_note:"Tip: use headphones so your mic won't pick up TTS audio.",quick_start:"Quick Start",qs1:"Open ‚ÄúPronunciation‚Äù or ‚ÄúCustom Phrase‚Äù.",qs2:"Click ‚ÄúSpeak‚Äù and read; percentage updates live.",qs3:"Best per phrase is saved automatically (üèÜ).",pron_title:"Pronunciation Training",level:"Level:",pack:"Phrase pack:",rec_lang:"Recognition language:",listen:"Listen",talk:"Speak",finish:"Stop",hint_keys:"Hotkeys: L ‚Äî listen, G ‚Äî speak, ‚Üê/‚Üí ‚Äî phrase",phrases:"Phrases",custom_title:"Custom Phrase",tips:"Tips",tip1:"Short phrases recognize more reliably. Start there.",tip2:"Use commas for pauses; try different TTS voices.",vocab_title:"Word Study",reveal:"Reveal translation",easy:"Easy",hard:"Hard",vocab_sets:"Word sets",settings_title:"Settings",tts_voice:"TTS voice:",rate:"Rate:",pitch:"Pitch:",volume:"Volume:",test:"Test",clear:"Clear best scores",about:"About",about_p:"Works offline (speech recognition & online translate depend on browser), stores progress locally, no install required."}};
let LANG='ru';const $=s=>document.querySelector(s),$$=s=>[...document.querySelectorAll(s)];
function applyI18N(){const d=I18N[LANG];$$('[data-i18n]').forEach(el=>{const k=el.getAttribute('data-i18n');if(d[k]) el.textContent=d[k];});$('#langLabel').textContent=LANG.toUpperCase();}
$('#langSwitch').addEventListener('change',e=>{LANG=e.target.checked?'en':'ru';document.documentElement.lang=LANG==='en'?'en':'ru';applyI18N();});
function goTab(id){$$('#tabs button').forEach(b=>b.classList.toggle('active',b.dataset.tab===id));['home','pronounce','custom','vocab','settings'].forEach(t=>$('#'+t).classList.toggle('hidden',t!==id));}
$('#tabs').addEventListener('click',e=>{if(e.target.tagName==='BUTTON') goTab(e.target.dataset.tab);});

/* ===== Random phrase generator bits ===== */
function PRNG(seed){let s=seed>>>0||1;return()=>{s=(s*1664525+1013904223)>>>0;return s/2**32}}
function choice(r,arr){return arr[Math.floor(r()*arr.length)]}
function cap(s){return s.charAt(0).toUpperCase()+s.slice(1)}
const WORDS={subjBeg:["I","You","He","She","We","They"],subjInt:["My boss","Our team","The client","The system","This app","The report"],subjAdv:["The committee","Market forces","Conventional wisdom","The hypothesis","Recent studies","Stakeholders"],verbsBeg:["like","need","want","have","see","know","find","try","feel","use","learn","travel to","work on","cook","buy"],verbsInt:["optimize","schedule","deliver","discuss","analyze","update","review","negotiate","prioritize","estimate","debug"],verbsAdv:["refute","corroborate","substantiate","synthesize","reconsider","generalize","reframe","deconstruct","challenge","contextualize"],objsBeg:["a book","coffee","a new phone","this idea","English","a ticket","a plan","a solution","a friend","a job","a meal"],objsInt:["the roadmap","our metrics","the proposal","a presentation","the dataset","user feedback","a prototype","the budget","requirements"],objsAdv:["the underlying premise","the causal link","our methodology","the initial assumption","the prevailing narrative","the counterexample"],places:["at home","at work","at school","in the office","in the city","in the kitchen","on the train","on the bus","at the airport","at the gym"],times:["today","tomorrow","yesterday","this week","next month","on Monday","every day","at night","in the morning","on weekends"]};
const TEMPLATES={beginner:[(r)=>`${choice(r,WORDS.subjBeg)} ${choice(r,WORDS.verbsBeg)} ${choice(r,WORDS.objsBeg)}.`,(r)=>`${choice(r,WORDS.subjBeg)} ${choice(r,WORDS.verbsBeg)} ${choice(r,WORDS.objsBeg)} ${choice(r,WORDS.places)}.`,(r)=>`${choice(r,WORDS.subjBeg)} ${choice(r,WORDS.verbsBeg)} ${choice(r,WORDS.objsBeg)} ${choice(r,WORDS.times)}.`,(r)=>`${choice(r,WORDS.subjBeg)} don't ${choice(r,WORDS.verbsBeg)} ${choice(r,WORDS.objsBeg)}.`,(r)=>`Do ${choice(r,WORDS.subjBeg).toLowerCase()} ${choice(r,WORDS.verbsBeg)} ${choice(r,WORDS.objsBeg)}?`],intermediate:[(r)=>`${choice(r,WORDS.subjInt)} will ${choice(r,WORDS.verbsInt)} ${choice(r,WORDS.objsInt)} ${choice(r,WORDS.times)}.`,(r)=>`${choice(r,WORDS.subjInt)} is ${choice(r,["currently","actively","partly"])} trying to ${choice(r,WORDS.verbsInt)} ${choice(r,WORDS.objsInt)}.`,(r)=>`${choice(r,WORDS.subjInt)} ${choice(r,["did","did not"])} ${choice(r,WORDS.verbsInt)} ${choice(r,WORDS.objsInt)} ${choice(r,["yesterday","last week","on Friday"])}.`,(r)=>`${choice(r,WORDS.subjInt)} should ${choice(r,WORDS.verbsInt)} ${choice(r,WORDS.objsInt)} ${choice(r,["soon","first","together"])}.`,(r)=>`If ${choice(r,WORDS.subjInt).toLowerCase()} ${choice(r,["can","cannot"])} ${choice(r,WORDS.verbsInt)} ${choice(r,WORDS.objsInt)}, we will ${choice(r,WORDS.verbsInt)} it later.`],advanced:[(r)=>`${choice(r,WORDS.subjAdv)} ${choice(r,["fundamentally","partially","empirically"])} ${choice(r,WORDS.verbsAdv)} ${choice(r,WORDS.objsAdv)}.`,(r)=>`${choice(r,WORDS.subjAdv)} may ${choice(r,["inadvertently","implicitly","explicitly"])} ${choice(r,WORDS.verbsAdv)} ${choice(r,WORDS.objsAdv)}.`,(r)=>`${choice(r,WORDS.subjAdv)} should ${choice(r,["thoroughly","cautiously","systematically"])} ${choice(r,WORDS.verbsAdv)} ${choice(r,WORDS.objsAdv)} ${choice(r,["before","after"])} we ${choice(r,WORDS.verbsAdv)} it.`,(r)=>`Although ${choice(r,WORDS.subjAdv).toLowerCase()} appears convincing, the data ${choice(r,["rarely","seldom","hardly ever"])} ${choice(r,["corroborate","support","validate"])} it.`,(r)=>`${choice(r,WORDS.subjAdv)} ${choice(r,["nevertheless","consequently","accordingly"])} ${choice(r,["suggests","implies","demonstrates"])} limitations.`]} ;
const BASE_PHRASES={beginner:{"Daily basics":["Hello, how are you?","Nice to meet you.","I live in Finland.","What time is it?","Could you help me?"],"Travel":["I would like a coffee, please.","Where is the bus station?","How much does it cost?","I have a reservation.","Can I pay by card?"]},intermediate:{"Small talk":["It's been a while, hasn't it?","I'm looking forward to the weekend.","The weather is quite unpredictable.","I work remotely most of the time.","Could you speak a bit slower?"],"Work":["Let's align on our priorities.","I'll share the draft by tomorrow.","This feature needs more polishing.","We need to reconsider the timeline.","I appreciate your feedback."]},advanced:{"Debate":["From a broader perspective, it's nuanced.","We should challenge our assumptions.","Let's quantify the potential trade-offs.","I strongly disagree with that premise.","The evidence suggests otherwise."],"Fluency":["He handled the situation gracefully.","That conclusion is far from inevitable.","It's a matter of balancing constraints.","I find that argument unconvincing.","We ended up reaching a compromise."]}};
const MINIMAL_PAIRS=[["ship","sheep"],["bit","beat"],["full","fool"],["live","leave"],["fit","feet"],["sit","seat"],["pull","pool"],["chip","cheap"],["wick","weak"],["hit","heat"],["cat","cut"],["bed","bad"],["man","men"],["hat","hut"],["pan","pen"]];
const TONGUE_TWISTERS=["She sells seashells by the seashore.","Red lorry, yellow lorry.","Truly rural.","Black background, brown background.","Unique New York.","A proper copper coffee pot.","Green glass globes glow greenly.","Six sleek swans swam swiftly southwards."];
function buildMinimalPairSentences(){const out=[];MINIMAL_PAIRS.forEach(([a,b])=>{out.push(`I saw a ${a} near the beach.`);out.push(`I saw a ${b} near the beach.`);out.push(`This ${a}/${b} contrast is tricky to pronounce.`);});return out;}
function makeMega(level,size=1200,seed=42){const r=PRNG(seed);const gens=TEMPLATES[level];const set=new Set();const arr=[];while(arr.length<size){const s=cap(choice(r,gens)(r)).replace(/\s+/g,' ').trim();if(!set.has(s)){set.add(s);arr.push(s);}}for(let i=arr.length-1;i>0;i--){const j=Math.floor(r()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];}return arr;}

/* ===== BIG VOCAB ===== */
const VOCAB={
  "Starter 1":[["apple","—è–±–ª–æ–∫–æ"],["book","–∫–Ω–∏–≥–∞"],["friend","–¥—Ä—É–≥"],["family","—Å–µ–º—å—è"],["city","–≥–æ—Ä–æ–¥"],["morning","—É—Ç—Ä–æ"],["water","–≤–æ–¥–∞"],["music","–º—É–∑—ã–∫–∞"],["work","—Ä–∞–±–æ—Ç–∞"],["travel","–ø—É—Ç–µ—à–µ—Å—Ç–≤–æ–≤–∞—Ç—å"]],
  "Starter 2":[["beautiful","–∫—Ä–∞—Å–∏–≤—ã–π"],["quickly","–±—ã—Å—Ç—Ä–æ"],["often","—á–∞—Å—Ç–æ"],["because","–ø–æ—Ç–æ–º—É —á—Ç–æ"],["before","–¥–æ"],["after","–ø–æ—Å–ª–µ"],["between","–º–µ–∂–¥—É"],["always","–≤—Å–µ–≥–¥–∞"],["usually","–æ–±—ã—á–Ω–æ"],["sometimes","–∏–Ω–æ–≥–¥–∞"]],
  "Core A1":[
    ["time","–≤—Ä–µ–º—è"],["day","–¥–µ–Ω—å"],["week","–Ω–µ–¥–µ–ª—è"],["month","–º–µ—Å—è—Ü"],["year","–≥–æ–¥"],["today","—Å–µ–≥–æ–¥–Ω—è"],["tomorrow","–∑–∞–≤—Ç—Ä–∞"],["yesterday","–≤—á–µ—Ä–∞"],
    ["morning","—É—Ç—Ä–æ"],["afternoon","–¥–µ–Ω—å"],["evening","–≤–µ—á–µ—Ä"],["night","–Ω–æ—á—å"],
    ["man","–º—É–∂—á–∏–Ω–∞"],["woman","–∂–µ–Ω—â–∏–Ω–∞"],["child","—Ä–µ–±—ë–Ω–æ–∫"],["people","–ª—é–¥–∏"],["name","–∏–º—è"],
    ["food","–µ–¥–∞"],["bread","—Ö–ª–µ–±"],["milk","–º–æ–ª–æ–∫–æ"],["tea","—á–∞–π"],["coffee","–∫–æ—Ñ–µ"],["sugar","—Å–∞—Ö–∞—Ä"],["salt","—Å–æ–ª—å"],["meat","–º—è—Å–æ"],["fish","—Ä—ã–±–∞"],["egg","—è–π—Ü–æ"],["rice","—Ä–∏—Å"],["soup","—Å—É–ø"],["fruit","—Ñ—Ä—É–∫—Ç—ã"],["vegetable","–æ–≤–æ—â"],
    ["breakfast","–∑–∞–≤—Ç—Ä–∞–∫"],["lunch","–æ–±–µ–¥"],["dinner","—É–∂–∏–Ω"],
    ["house","–¥–æ–º"],["room","–∫–æ–º–Ω–∞—Ç–∞"],["kitchen","–∫—É—Ö–Ω—è"],["bathroom","–≤–∞–Ω–Ω–∞—è"],["bed","–∫—Ä–æ–≤–∞—Ç—å"],["table","—Å—Ç–æ–ª"],["chair","—Å—Ç—É–ª"],["window","–æ–∫–Ω–æ"],["door","–¥–≤–µ—Ä—å"],["key","–∫–ª—é—á"],
    ["street","—É–ª–∏—Ü–∞"],["road","–¥–æ—Ä–æ–≥–∞"],["shop","–º–∞–≥–∞–∑–∏–Ω"],["market","—Ä—ã–Ω–æ–∫"],["bank","–±–∞–Ω–∫"],["post office","–ø–æ—á—Ç–∞"],["hospital","–±–æ–ª—å–Ω–∏—Ü–∞"],["pharmacy","–∞–ø—Ç–µ–∫–∞"],["school","—à–∫–æ–ª–∞"],["university","—É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç"],["airport","–∞—ç—Ä–æ–ø–æ—Ä—Ç"],["station","—Å—Ç–∞–Ω—Ü–∏—è"],
    ["bus","–∞–≤—Ç–æ–±—É—Å"],["train","–ø–æ–µ–∑–¥"],["ticket","–±–∏–ª–µ—Ç"],["car","–º–∞—à–∏–Ω–∞"],["bike","–≤–µ–ª–æ—Å–∏–ø–µ–¥"],["taxi","—Ç–∞–∫—Å–∏"],
    ["left","–ª–µ–≤–æ"],["right","–ø—Ä–∞–≤–æ"],["straight","–ø—Ä—è–º–æ"],["near","—Ä—è–¥–æ–º"],["far","–¥–∞–ª–µ–∫–æ"],
    ["small","–º–∞–ª–µ–Ω—å–∫–∏–π"],["big","–±–æ–ª—å—à–æ–π"],["long","–¥–ª–∏–Ω–Ω—ã–π"],["short","–∫–æ—Ä–æ—Ç–∫–∏–π"],["good","—Ö–æ—Ä–æ—à–∏–π"],["bad","–ø–ª–æ—Ö–æ–π"],["easy","–ª—ë–≥–∫–∏–π"],["difficult","—Å–ª–æ–∂–Ω—ã–π"],["new","–Ω–æ–≤—ã–π"],["old","—Å—Ç–∞—Ä—ã–π/—Å—Ç–∞—Ä–æ–µ"],["hot","–≥–æ—Ä—è—á–∏–π"],["cold","—Ö–æ–ª–æ–¥–Ω—ã–π"],
    ["open","–æ—Ç–∫—Ä—ã–≤–∞—Ç—å"],["close","–∑–∞–∫—Ä—ã–≤–∞—Ç—å"],["come","–ø—Ä–∏—Ö–æ–¥–∏—Ç—å"],["go","–∏–¥—Ç–∏"],["take","–±—Ä–∞—Ç—å"],["give","–¥–∞–≤–∞—Ç—å"],["find","–Ω–∞—Ö–æ–¥–∏—Ç—å"],["need","–Ω—É–∂–Ω–æ"],["want","—Ö–æ—Ç–µ—Ç—å"],["like","–Ω—Ä–∞–≤–∏—Ç—å—Å—è"],["know","–∑–Ω–∞—Ç—å"],["understand","–ø–æ–Ω–∏–º–∞—Ç—å"],["help","–ø–æ–º–æ–≥–∞—Ç—å"],["call","–∑–≤–æ–Ω–∏—Ç—å"],
    ["buy","–ø–æ–∫—É–ø–∞—Ç—å"],["sell","–ø—Ä–æ–¥–∞–≤–∞—Ç—å"],["pay","–ø–ª–∞—Ç–∏—Ç—å"],["cost","—Å—Ç–æ–∏—Ç—å"],["cheap","–¥–µ—à—ë–≤—ã–π"],["expensive","–¥–æ—Ä–æ–≥–æ–π"],
    ["now","—Å–µ–π—á–∞—Å"],["here","–∑–¥–µ—Å—å"],["there","—Ç–∞–º"],["who","–∫—Ç–æ"],["what","—á—Ç–æ"],["where","–≥–¥–µ"],["when","–∫–æ–≥–¥–∞"],["why","–ø–æ—á–µ–º—É"],["how","–∫–∞–∫"]
  ],
  "Core A2":[
    ["early","—Ä–∞–Ω–æ"],["late","–ø–æ–∑–¥–Ω–æ"],["busy","–∑–∞–Ω—è—Ç–æ–π"],["free","—Å–≤–æ–±–æ–¥–Ω—ã–π"],["ready","–≥–æ—Ç–æ–≤—ã–π"],["sure","—É–≤–µ—Ä–µ–Ω–Ω—ã–π"],["maybe","–≤–æ–∑–º–æ–∂–Ω–æ"],
    ["already","—É–∂–µ"],["still","–≤—Å—ë –µ—â—ë"],["just","—Ç–æ–ª—å–∫–æ —á—Ç–æ"],["almost","–ø–æ—á—Ç–∏"],["enough","–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ"],
    ["always","–≤—Å–µ–≥–¥–∞"],["often","—á–∞—Å—Ç–æ"],["rarely","—Ä–µ–¥–∫–æ"],["never","–Ω–∏–∫–æ–≥–¥–∞"],
    ["begin","–Ω–∞—á–∏–Ω–∞—Ç—å"],["finish","–∑–∞–∫–∞–Ω—á–∏–≤–∞—Ç—å"],["continue","–ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å"],["improve","—É–ª—É—á—à–∞—Ç—å"],["try","–ø—ã—Ç–∞—Ç—å—Å—è"],["decide","—Ä–µ—à–∞—Ç—å"],["choose","–≤—ã–±–∏—Ä–∞—Ç—å"],
    ["invite","–ø—Ä–∏–≥–ª–∞—à–∞—Ç—å"],["agree","—Å–æ–≥–ª–∞—à–∞—Ç—å—Å—è"],["prefer","–ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞—Ç—å"],["remember","–ø–æ–º–Ω–∏—Ç—å"],["forget","–∑–∞–±—ã–≤–∞—Ç—å"],
    ["send","–æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å"],["receive","–ø–æ–ª—É—á–∞—Ç—å"],["borrow","–±—Ä–∞—Ç—å –≤–∑–∞–π–º—ã"],["lend","–¥–∞–≤–∞—Ç—å –≤–∑–∞–π–º—ã"],["bring","–ø—Ä–∏–Ω–æ—Å–∏—Ç—å"],["carry","–Ω–µ—Å—Ç–∏"],["keep","—Ö—Ä–∞–Ω–∏—Ç—å"],["lose","—Ç–µ—Ä—è—Ç—å"],["win","–ø–æ–±–µ–∂–¥–∞—Ç—å"],
    ["clean","—á–∏—Å—Ç–∏—Ç—å"],["wash","–º—ã—Ç—å"],["cook","–≥–æ—Ç–æ–≤–∏—Ç—å"],["drive","–≤–µ—Å—Ç–∏ (–º–∞—à–∏–Ω—É)"],["travel","–ø—É—Ç–µ—à–µ—Å—Ç–≤–æ–≤–∞—Ç—å"],["arrive","–ø—Ä–∏–±—ã–≤–∞—Ç—å"],["leave","—É–µ–∑–∂–∞—Ç—å"],
    ["healthy","–∑–¥–æ—Ä–æ–≤—ã–π"],["tired","—É—Å—Ç–∞–≤—à–∏–π"],["hungry","–≥–æ–ª–æ–¥–Ω—ã–π"],["thirsty","—Ö–æ—á—É—â–∏–π –ø–∏—Ç—å"],["angry","–∑–ª–æ–π"],["afraid","–∏—Å–ø—É–≥–∞–Ω–Ω—ã–π"],["happy","—Å—á–∞—Å—Ç–ª–∏–≤—ã–π"],["sad","–≥—Ä—É—Å—Ç–Ω—ã–π"],
    ["beautiful","–∫—Ä–∞—Å–∏–≤—ã–π"],["quiet","—Ç–∏—Ö–∏–π"],["noisy","—à—É–º–Ω—ã–π"],["comfortable","—É–¥–æ–±–Ω—ã–π"],["useful","–ø–æ–ª–µ–∑–Ω—ã–π"],["necessary","–Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–π"],
    ["internet","–∏–Ω—Ç–µ—Ä–Ω–µ—Ç"],["email","—ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞"],["message","—Å–æ–æ–±—â–µ–Ω–∏–µ"],["password","–ø–∞—Ä–æ–ª—å"],["file","—Ñ–∞–π–ª"],["folder","–ø–∞–ø–∫–∞"],["download","—Å–∫–∞—á–∏–≤–∞—Ç—å"],["upload","–∑–∞–≥—Ä—É–∂–∞—Ç—å"],
    ["meeting","–≤—Å—Ç—Ä–µ—á–∞"],["report","–æ—Ç—á—ë—Ç"],["project","–ø—Ä–æ–µ–∫—Ç"],["task","–∑–∞–¥–∞—á–∞"],["deadline","–¥–µ–¥–ª–∞–π–Ω"],["salary","–∑–∞—Ä–ø–ª–∞—Ç–∞"],["vacation","–æ—Ç–ø—É—Å–∫"],
    ["doctor","–≤—Ä–∞—á"],["patient","–ø–∞—Ü–∏–µ–Ω—Ç"],["medicine","–ª–µ–∫–∞—Ä—Å—Ç–≤–æ"],["appointment","–∑–∞–ø–∏—Å—å (–∫ –≤—Ä–∞—á—É)"],
    ["rain","–¥–æ–∂–¥—å"],["snow","—Å–Ω–µ–≥"],["wind","–≤–µ—Ç–µ—Ä"],["cloud","–æ–±–ª–∞–∫–æ"],["weather","–ø–æ–≥–æ–¥–∞"],["temperature","—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞"],
    ["north","—Å–µ–≤–µ—Ä"],["south","—é–≥"],["east","–≤–æ—Å—Ç–æ–∫"],["west","–∑–∞–ø–∞–¥"],
    ["opinion","–º–Ω–µ–Ω–∏–µ"],["advice","—Å–æ–≤–µ—Ç"],["reason","–ø—Ä–∏—á–∏–Ω–∞"],["problem","–ø—Ä–æ–±–ª–µ–º–∞"],["solution","—Ä–µ—à–µ–Ω–∏–µ"]
  ]
};

/* ===== Similarity ===== */
function norm(s){return (s||"").toLowerCase().replace(/[^a-z'\s]+/g,'').replace(/\s+/g,' ').trim();}
function levenshtein(a,b){a=norm(a);b=norm(b);const m=a.length,n=b.length;if(!m) return n;if(!n) return m;const dp=Array(n+1);for(let j=0;j<=n;j++) dp[j]=j;for(let i=1;i<=m;i++){let prev=dp[0]++;for(let j=1;j<=n;j++){const tmp=dp[j];dp[j]=Math.min(dp[j]+1,dp[j-1]+1,prev+(a[i-1]===b[j-1]?0:1));prev=tmp;}}return dp[n]}
function similarity(a,b){a=norm(a);b=norm(b);if(!a&&!b) return 1;const d=levenshtein(a,b);const m=Math.max(a.length,b.length)||1;return 1-d/m}
function pct(x){return Math.round(x*100)}
function setBar(el,v){el.style.width=Math.max(0,Math.min(100,v))+'%'}
function setScoreClass(el,score){el.classList.remove('good','mid','bad');el.classList.add(score>=85?'good':score>=60?'mid':'bad')}

/* ===== Speech & VU ===== */
const synth=window.speechSynthesis;let voices=[];
function populateVoices(){voices=synth.getVoices().filter(v=>/^en/i.test(v.lang));const sel=$('#voiceSel');if(!sel) return;sel.innerHTML='';voices.forEach((v,i)=>{const o=document.createElement('option');o.value=i;o.textContent=`${v.name} ‚Äî ${v.lang}`;sel.appendChild(o);});if(voices.length) sel.value=0;}
populateVoices();if(typeof speechSynthesis!=='undefined'){speechSynthesis.onvoiceschanged=populateVoices;}
function speak(text){if(!text) return;const u=new SpeechSynthesisUtterance(text);const v=voices[$('#voiceSel').value]||voices[0];if(v) u.voice=v;u.rate=parseFloat($('#rate')?.value||1);u.pitch=parseFloat($('#pitch')?.value||1);u.volume=parseFloat($('#volume')?.value||1);speechSynthesis.cancel();speechSynthesis.speak(u);}

let recognizer=null,recognizing=false,liveBuffer='';
function initRecognizer(lang){const SR=window.SpeechRecognition||window.webkitSpeechRecognition; if(!SR){$('#permNote')&&($('#permNote').textContent='‚ö†Ô∏è Web Speech API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —ç—Ç–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º.'); return null;} const r=new SR(); r.lang=lang||'en-US'; r.interimResults=true; r.continuous=true; r.maxAlternatives=1; return r;}
function startRecognition(lang,onUpdate,onEnd){
  if(recognizing){ try{recognizer&&recognizer.stop();}catch(e){} recognizing=false; }
  recognizer=initRecognizer(lang);
  if(!recognizer) return;
  liveBuffer='';
  recognizer.onresult=(ev)=>{let interim='';for(let i=ev.resultIndex;i<ev.results.length;i++){const res=ev.results[i];if(res.isFinal) liveBuffer+=res[0].transcript;else interim+=res[0].transcript;}onUpdate(liveBuffer+interim);};
  recognizer.onend=()=>{recognizing=false; onEnd&&onEnd(liveBuffer);};
  recognizer.onerror=(e)=>{console.warn(e); recognizing=false; onEnd&&onEnd(liveBuffer);};
  recognizer.start(); recognizing=true;
}
function stopRecognition(){try{recognizer&&recognizer.stop();}catch(e){} recognizing=false;}

let audioCtx,analyser,rafVU;
async function ensureVU(el){ try{ if(!audioCtx){ audioCtx=new (window.AudioContext||window.webkitAudioContext)(); const stream=await navigator.mediaDevices.getUserMedia({audio:true}); const src=audioCtx.createMediaStreamSource(stream); analyser=audioCtx.createAnalyser(); analyser.fftSize=1024; src.connect(analyser); } const bars=[...el.children]; if(!bars.length){ for(let i=0;i<32;i++){const d=document.createElement('div');el.appendChild(d);} } const buf=new Uint8Array(analyser.frequencyBinCount);
  function loop(){ analyser.getByteTimeDomainData(buf); let sum=0; for(let i=0;i<buf.length;i++){const v=(buf[i]-128)/128; sum+=v*v;} const rms=Math.sqrt(sum/buf.length); const level=Math.min(1,rms*6); const active=Math.floor(level*bars.length); bars.forEach((b,idx)=>{const on=idx<active; b.style.height=(on?20+idx%5*6:6)+'px'; b.style.background=on?`linear-gradient(180deg, ${idx>bars.length*0.7?'#ff5c7a':idx>bars.length*0.4?'#ffcf5c':'#35d07f'}, #1a2330)`:'#101826';}); rafVU=requestAnimationFrame(loop); } cancelAnimationFrame(rafVU); loop(); }catch(e){ console.warn(e); $('#permNote')&&($('#permNote').textContent='–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ.'); }}

/* ===== Google-accurate Translator (EN‚ÜíRU) ===== */
const trCache=new Map();
function setTranslatorStatus(msg){const el=$('#translatorStatus');if(el) el.textContent=msg;}

function hasCyrillic(s){return /[–ê-–Ø–∞-—è–Å—ë]/.test(s);}

// Parse Google translate_a/single response
function parseGtx(json){
  // json is array: [[["–ø–µ—Ä–µ–≤–æ–¥","source",...],...],...]
  const arr=json && json[0]; if(!Array.isArray(arr)) return '';
  let out='';
  for(const seg of arr){ if(seg && seg[0]) out+=seg[0]; }
  return out;
}

async function translateGoogle(text){
  const key='gtx:'+text.trim();
  if(trCache.has(key)) return trCache.get(key);
  try{
    const url=`https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=ru&dt=t&q=${encodeURIComponent(text)}`;
    const resp=await fetch(url,{headers:{'Accept':'application/json'}});
    const data=await resp.json();
    let out=parseGtx(data)||'';
    out=out.replace(/&quot;/g,'"').replace(/&#39;/g,"'");
    if(!hasCyrillic(out)){ throw new Error('Non-RU result'); }
    trCache.set(key,out); setTranslatorStatus('Google');
    return out;
  }catch(e){
    console.warn('Google translate failed/returned non-RU, fallback to MyMemory',e);
    setTranslatorStatus('Google fallback');
    return await translateMyMemory(text);
  }
}

async function translateMyMemory(text){
  const key='mm:'+text.trim();
  if(trCache.has(key)) return trCache.get(key);
  try{
    const url=`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=en|ru`;
    const resp=await fetch(url,{headers:{'Accept':'application/json'}});
    const data=await resp.json();
    let out=(data && data.responseData && data.responseData.translatedText)||'';
    out=out.replace(/&quot;/g,'"').replace(/&#39;/g,"'");
    if(!hasCyrillic(out)) out='';
    trCache.set(key,out); return out;
  }catch(e){ console.warn('MyMemory failed',e); return ''; }
}

async function smartTranslate(text){
  const g=await translateGoogle(text);
  return g || (await translateMyMemory(text)) || text;
}

function debounce(fn,ms){let t;return (...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);}}

/* ===== State & UI bindings ===== */
let state={level:'beginner',packKey:null,phrases:[],idx:0,target:'',live:'',best:0};
function bestKey(level,pack,phrase){return `best::${level}::${pack}::${phrase}`}
function loadBestBadge(){const key=bestKey(state.level,state.packKey,state.target);const best=parseInt(localStorage.getItem(key)||'0',10);state.best=best;$('#bestRecord').textContent='üèÜ '+best+'%';}
async function applyPhrase(){
  state.target=state.phrases[state.idx]||'';
  $('#targetPhrase').textContent=state.target;
  $('#targetTrans').textContent='‚Ä¶';
  $('#gtTarget').href=`https://translate.google.com/?sl=en&tl=ru&text=${encodeURIComponent(state.target)}&op=translate`;
  $('#liveText').textContent=''; $('#liveTrans').textContent='';
  $('#gtLive').href=`https://translate.google.com/?sl=en&tl=ru&text=&op=translate`;
  $('#simText').textContent='0%';$('#simText').className='score';setBar($('#simBar'),0);
  loadBestBadge();
  $('#targetTrans').textContent=await smartTranslate(state.target);
}
const liveTranslateDebounced=debounce(async ()=>{
  const txt=$('#liveText').textContent||'';
  $('#liveTrans').textContent=txt? '‚Ä¶' : '';
  if(txt){ $('#liveTrans').textContent=await smartTranslate(txt); }
},250);

function rebuildPhraseList(){const list=$('#phraseList');list.innerHTML='';state.phrases.forEach((p,i)=>{const btn=document.createElement('button');btn.className='phrase row';const left=document.createElement('span');left.textContent=p;const right=document.createElement('span');right.className='pill';right.textContent='‚ñ∂';btn.append(left,right);btn.onclick=()=>{state.idx=i;applyPhrase()};list.appendChild(btn);});}
function maybeSaveBest(score){const key=bestKey(state.level,state.packKey,state.target);const prev=parseInt(localStorage.getItem(key)||'0',10);if(score>prev){localStorage.setItem(key,String(score));state.best=score;$('#bestRecord').textContent='üèÜ '+score+'%';}}
function onLiveUpdate(txt){
  state.live=txt;$('#liveText').textContent=txt;
  liveTranslateDebounced();
  const s=pct(similarity(state.target,txt));setBar($('#simBar'),s);const el=$('#simText');el.textContent=s+'%';setScoreClass(el,s);maybeSaveBest(s);
}
function onEndFinal(){}

/* ===== Custom phrase ===== */
let custom={target:'',live:'',best:0};
const customTranslateDebounced=debounce(async ()=>{
  const txt=$('#liveCustom').textContent||'';
  $('#liveCustomTrans').textContent=txt? '‚Ä¶' : '';
  if(txt){ $('#liveCustomTrans').textContent=await smartTranslate(txt); }
},250);
async function onLiveUpdateCustom(txt){
  custom.live=txt;$('#liveCustom').textContent=txt;
  customTranslateDebounced();
  const s=pct(similarity(custom.target,txt));setBar($('#simBarCustom'),s);const el=$('#simTextCustom');el.textContent=s+'%';setScoreClass(el,s);
  const key=`best::custom::${custom.target}`;const prev=parseInt(localStorage.getItem(key)||'0',10);if(s>prev){localStorage.setItem(key,String(s));}
}
function onEndFinalCustom(){}

/* ===== Vocab ===== */
let vocab={setKeys:Object.keys(VOCAB),idxSet:0,idxWord:0};
function applyVocabSet(){const key=vocab.setKeys[vocab.idxSet];const list=VOCAB[key];$('#vocabList').innerHTML='';vocab.setKeys.forEach((k,i)=>{const b=document.createElement('button');b.className='phrase row';b.textContent=k;b.onclick=()=>{vocab.idxSet=i;vocab.idxWord=0;applyVocabWord();applyVocabSet();};if(i===vocab.idxSet) b.style.outline='2px solid var(--accent)';$('#vocabList').appendChild(b);});$('#vocabProgress').textContent=`${vocab.idxWord+1}/${list.length}`;}
function applyVocabWord(){const set=VOCAB[vocab.setKeys[vocab.idxSet]];const [w,t]=set[vocab.idxWord];$('#vocabWord').textContent=w;$('#vocabTrans').textContent=t;$('#vocabTrans').style.display='none';$('#vocabProgress').textContent=`${vocab.idxWord+1}/${set.length}`;}

/* ===== Phrase packs ===== */
let PHRASES=null;
function buildPhrasePacks(){
  PHRASES={beginner:{},intermediate:{},advanced:{}};
  Object.assign(PHRASES.beginner,BASE_PHRASES.beginner);
  Object.assign(PHRASES.intermediate,BASE_PHRASES.intermediate);
  Object.assign(PHRASES.advanced,BASE_PHRASES.advanced);
  const mp=buildMinimalPairSentences();
  PHRASES.beginner["Minimal Pairs (Pronunciation)"]=mp.slice(0,Math.min(120,mp.length));
  PHRASES.intermediate["Minimal Pairs (Pronunciation)"]=mp;
  PHRASES.beginner["Tongue Twisters"]=TONGUE_TWISTERS;
  PHRASES.intermediate["Tongue Twisters"]=TONGUE_TWISTERS;
  PHRASES.advanced["Tongue Twisters"]=TONGUE_TWISTERS;
  const size=parseInt($('#megaSize')?.value||1200,10);
  const seed=parseInt($('#megaSeed')?.value||42,10);
  PHRASES.beginner["Mega Pack (Auto)"]=makeMega('beginner',size,seed);
  PHRASES.intermediate["Mega Pack (Auto)"]=makeMega('intermediate',size,seed+1);
  PHRASES.advanced["Mega Pack (Auto)"]=makeMega('advanced',size,seed+2);
}
function loadPackList(){
  const packSel=$('#packSel');packSel.innerHTML='';
  const packs=PHRASES[state.level];
  Object.keys(packs).forEach((k)=>{const opt=document.createElement('option');opt.value=k;opt.textContent=k;packSel.appendChild(opt);});
  state.packKey=Object.keys(packs)[0];packSel.value=state.packKey;
  state.phrases=packs[state.packKey];state.idx=0;applyPhrase();rebuildPhraseList();
}

/* ===== Pack Updater (URL & File) ===== */
function mergePacks(newPacks){
  let count=0;
  for(const k of Object.keys(newPacks||{})){
    if(Array.isArray(newPacks[k])){
      if(Array.isArray(newPacks[k][0]) && newPacks[k][0].length===2){
        VOCAB[k]=newPacks[k]; count+=newPacks[k].length;
      }else{
        if(!PHRASES) buildPhrasePacks();
        (PHRASES.beginner[k]??=newPacks[k]);
        (PHRASES.intermediate[k]??=newPacks[k]);
        (PHRASES.advanced[k]??=newPacks[k]);
        count+=newPacks[k].length;
      }
    }
  }
  vocab.setKeys=Object.keys(VOCAB);
  applyVocabSet();
  return count;
}
async function loadPacksFromUrl(){
  const url=$('#packsUrl').value.trim();
  if(!url) return alert('–£–∫–∞–∂–∏—Ç–µ URL –¥–æ JSON.');
  try{
    const resp=await fetch(url);
    const json=await resp.json();
    const n=mergePacks(json);
    alert('–ó–∞–≥—Ä—É–∂–µ–Ω–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤: '+n);
    loadPackList();
  }catch(e){ console.error(e); alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å JSON –ø–æ URL. –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏.'); }
}
function loadPacksFromFile(){
  const f=$('#packsFile').files[0];
  if(!f) return alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª JSON.');
  const reader=new FileReader();
  reader.onload=()=>{
    try{
      const json=JSON.parse(reader.result);
      const n=mergePacks(json);
      alert('–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤: '+n);
      loadPackList();
    }catch(e){ console.error(e); alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON –∏–∑ —Ñ–∞–π–ª–∞.'); }
  };
  reader.readAsText(f);
}

/* ===== Custom vocab import ===== */
function parseUserVocab(text){
  const lines=text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const items=[];
  for(const line of lines){
    const m=line.split(/[-‚Äì‚Äî;]|->|:/);
    if(m.length>=2){
      const w=(m[0]||'').trim(); const t=(m.slice(1).join(' ')||'').trim();
      if(w && t) items.push([w,t]);
    }
  }
  return items;
}

/* ===== Init ===== */
function initUI(){
  const vus=[$('#vu'),$('#vu2')];vus.forEach(el=>{if(el){for(let i=0;i<32;i++){const d=document.createElement('div');el.appendChild(d);} ensureVU(el);}});

  // Translator mode button left for future, but fixed Google under the hood
  $('#toggleTranslator').onclick=()=>{setTranslatorStatus('Google');};

  buildPhrasePacks();

  $('#levelSel').addEventListener('change',e=>{state.level=e.target.value;loadPackList();});
  $('#packSel').addEventListener('change',e=>{state.packKey=e.target.value;state.phrases=PHRASES[state.level][state.packKey];state.idx=0;applyPhrase();rebuildPhraseList();});
  $('#regenMega').addEventListener('click',()=>{buildPhrasePacks();loadPackList();});

  $('#loadPacksUrl').onclick=loadPacksFromUrl;
  $('#loadPacksFile').onclick=loadPacksFromFile;

  $('#speakBtn').onclick=()=>speak(state.target);
  $('#recBtn').onclick=()=>{startRecognition($('#recLang').value,onLiveUpdate,onEndFinal);};
  $('#finishBtn').onclick=()=>stopRecognition();
  $('#prevBtn').onclick=()=>{state.idx=(state.idx-1+state.phrases.length)%state.phrases.length;applyPhrase();};
  $('#nextBtn').onclick=()=>{state.idx=(state.idx+1)%state.phrases.length;applyPhrase();};

  window.addEventListener('keydown',(e)=>{if(e.key.toLowerCase()==='l') $('#speakBtn').click();if(e.key.toLowerCase()==='g') $('#recBtn').click();if(e.key==='ArrowLeft') $('#prevBtn').click();if(e.key==='ArrowRight') $('#nextBtn').click();});

  $('#ttsCustom').onclick=async()=>{custom.target=$('#customText').value.trim();$('#customTargetTrans').textContent=await smartTranslate(custom.target);$('#gtCustomTarget').href=`https://translate.google.com/?sl=en&tl=ru&text=${encodeURIComponent(custom.target)}&op=translate`;speak(custom.target);};
  $('#recCustom').onclick=async()=>{custom.target=$('#customText').value.trim()||' ';$('#customTargetTrans').textContent=await smartTranslate(custom.target);$('#gtCustomTarget').href=`https://translate.google.com/?sl=en&tl=ru&text=${encodeURIComponent(custom.target)}&op=translate`;startRecognition($('#recLang')?.value||'en-US',onLiveUpdateCustom,onEndFinalCustom);};
  $('#finishCustom').onclick=()=>stopRecognition();

  vocab.setKeys=Object.keys(VOCAB);
  applyVocabSet();applyVocabWord();
  $('#vocabPrev').onclick=()=>{const set=VOCAB[vocab.setKeys[vocab.idxSet]];vocab.idxWord=(vocab.idxWord-1+set.length)%set.length;applyVocabWord();};
  $('#vocabNext').onclick=()=>{const set=VOCAB[vocab.setKeys[vocab.idxSet]];vocab.idxWord=(vocab.idxWord+1)%set.length;applyVocabWord();};
  $('#vocabSpeak').onclick=()=>speak($('#vocabWord').textContent);
  $('#vocabReveal').onclick=()=>$('#vocabTrans').style.display='block';
  $('#markEasy').onclick=()=>{$('#vocabNext').click();};
  $('#markHard').onclick=()=>{$('#vocabNext').click();};

  $('#addVocabSet').onclick=()=>{
    const name=($('#vocabSetName').value||'My Words').trim();
    const items=parseUserVocab($('#vocabImport').value||'');
    if(!items.length){alert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É —Å–æ —Å–ª–æ–≤–æ–º –∏ –ø–µ—Ä–µ–≤–æ–¥–æ–º.');return;}
    VOCAB[name]=items;
    vocab.setKeys=Object.keys(VOCAB);
    vocab.idxSet=vocab.setKeys.indexOf(name);
    vocab.idxWord=0;
    applyVocabWord();applyVocabSet();
    $('#vocabImport').value='';
    alert(`–ù–∞–±–æ—Ä ¬´${name}¬ª –¥–æ–±–∞–≤–ª–µ–Ω: ${items.length} —Å–ª–æ–≤.`);
  };

  $('#supportNote').textContent='üé§ '+(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?'–ú–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è':'–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è')+' ¬∑ '+((window.SpeechRecognition||window.webkitSpeechRecognition)?'–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è':'–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');

  setTranslatorStatus('Google');
  applyI18N();
  loadPackList();
}
initUI();
document.addEventListener('visibilitychange',()=>{if(document.hidden) stopRecognition();});
</script>
</body>
</html>
